<script>
  // --- CAREGIVER CALENDAR LOGIC ---
  let currentCalendarDate = new Date();
  let currentMiniMonthDate = new Date();

  function loadCaregiverCalendar() {
    renderWeekCalendar();
    renderMiniMonthCalendar();
  }

  function changeWeek(offset) {
    currentCalendarDate.setDate(currentCalendarDate.getDate() + offset * 7);
    renderWeekCalendar();
  }

  function changeMiniMonth(offset) {
    currentMiniMonthDate.setMonth(currentMiniMonthDate.getMonth() + offset);
    renderMiniMonthCalendar();
  }

  function renderWeekCalendar() {
    const grid = document.getElementById("weekGrid");
    grid.innerHTML =
      '<div class="col-span-7 text-center p-4 text-gray-400">Loading...</div>';

    // Calculate start of week (Sunday)
    const startOfWeek = new Date(currentCalendarDate);
    const day = startOfWeek.getDay();
    const diff = startOfWeek.getDate() - day;
    startOfWeek.setDate(diff);

    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);

    // Update Label
    const options = { month: "short", day: "numeric" };
    const label = `${startOfWeek.toLocaleDateString(
      "en-US",
      options
    )} - ${endOfWeek.toLocaleDateString("en-US", {
      ...options,
      year: "numeric",
    })}`;
    document.getElementById("currentWeekLabel").textContent = label;

    // Fetch Shifts
    const startStr = startOfWeek.toISOString().split("T")[0];
    const endStr = endOfWeek.toISOString().split("T")[0];

    google.script.run
      .withSuccessHandler((shifts) => {
        grid.innerHTML = "";

        // Generate 7 columns
        for (let i = 0; i < 7; i++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + i);
          const dateStr = currentDay.toISOString().split("T")[0];

          const isToday =
            new Date().toDateString() === currentDay.toDateString();

          const col = document.createElement("div");
          col.className = `border-r border-gray-100 min-h-[400px] flex flex-col ${
            isToday ? "bg-blue-50/30" : ""
          }`;

          // Date Header
          col.innerHTML = `
          <div class="p-2 text-center border-b border-gray-100 ${
            isToday ? "bg-blue-50 text-blue-600" : ""
          }">
            <span class="text-lg font-bold block">${currentDay.getDate()}</span>
          </div>
          <div class="flex-1 p-2 space-y-2" id="day-${dateStr}"></div>
        `;
          grid.appendChild(col);

          // Add Shifts
          const dayShifts = shifts.filter((s) => s.date === dateStr);
          const container = col.querySelector(`#day-${dateStr}`);

          dayShifts.forEach((s) => {
            // Find names from global data if available, else use ID
            const cg = cgData.find((c) => c.id === s.caregiverId);
            const cl = clData.find((c) => c.id === s.clientId);
            const cgName = cg ? cg.name : s.caregiverId;
            const clName = cl ? cl.firstName + " " + cl.lastName : s.clientId;

            const card = document.createElement("div");
            card.className =
              "bg-white p-2 rounded border border-l-4 border-l-[#65c027] shadow-sm text-xs hover:shadow-md transition cursor-pointer";
            card.innerHTML = `
             <div class="font-bold text-gray-700 truncate">${clName}</div>
             <div class="text-gray-500 truncate">${cgName}</div>
             <div class="mt-1 flex justify-between text-[10px] text-gray-400">
               <span>${s.clockIn} - ${s.clockOut}</span>
             </div>
           `;
            container.appendChild(card);
          });
        }
      })
      .getShifts(startStr, endStr);
  }

  function renderMiniMonthCalendar() {
    const grid = document.getElementById("miniMonthGrid");
    grid.innerHTML = "";

    const year = currentMiniMonthDate.getFullYear();
    const month = currentMiniMonthDate.getMonth();

    document.getElementById("miniMonthLabel").textContent =
      currentMiniMonthDate.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric",
      });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Empty cells for start padding
    for (let i = 0; i < firstDay.getDay(); i++) {
      grid.appendChild(document.createElement("div"));
    }

    // Days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      const d = new Date(year, month, i);
      const isToday = new Date().toDateString() === d.toDateString();

      const cell = document.createElement("div");
      cell.className = `p-1 rounded-full cursor-pointer hover:bg-gray-100 ${
        isToday ? "bg-[#65c027] text-white font-bold" : "text-gray-700"
      }`;
      cell.textContent = i;
      cell.onclick = () => {
        currentCalendarDate = new Date(year, month, i);
        renderWeekCalendar();
      };
      grid.appendChild(cell);
    }
  }
</script>
